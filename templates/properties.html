{% extends 'base.html' %}

{% block title %}Properties - StayFinder Admin{% endblock %}

{% block extra_css %}
body {
    background: #f4f6f9;
}
.sidebar {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    position: fixed;
    width: 250px;
}
.sidebar a {
    color: rgba(255,255,255,0.8);
    text-decoration: none;
    padding: 12px 20px;
    display: block;
    transition: all 0.3s;
}
.sidebar a:hover, .sidebar a.active {
    background: rgba(255,255,255,0.1);
    color: #fff;
}
.main-content {
    margin-left: 250px;
    padding: 30px;
}
.property-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s;
    overflow: hidden;
    height: 100%;
    display: flex;
    flex-direction: column;
}
.property-card:hover {
    transform: translateY(-5px);
}
.property-card .card-img-container {
    height: 200px;
    overflow: hidden;
    background: #f0f0f0;
    position: relative;
}
.property-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}
.property-card .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
}
.property-card .card-body .price-section {
    margin-top: auto;
}
.badge-type {
    position: absolute;
    top: 10px;
    left: 10px;
}
.badge-gender {
    position: absolute;
    top: 10px;
    right: 10px;
}
.badge-status {
    position: absolute;
    bottom: 10px;
    left: 10px;
}
.amenity-badge {
    font-size: 0.75rem;
    padding: 5px 10px;
    margin: 2px;
    border-radius: 20px;
    background: #e3f2fd;
    color: #1976d2;
}
.price-original {
    text-decoration: line-through;
    color: #999;
    font-size: 0.9rem;
}
.price-discounted {
    color: #1976d2;
    font-weight: bold;
    font-size: 1.3rem;
}
.action-buttons {
    gap: 8px;
    margin-top: 10px;
}
.action-buttons form {
    flex: 1;
}
.action-buttons button {
    width: 100%;
    font-size: 0.85rem;
}
{% endblock %}

{% block content %}
<!-- Sidebar -->
<div class="sidebar">
    <div class="p-3 text-white border-bottom border-light border-opacity-25">
        <h4 class="mb-0"><i class="bi bi-house-door"></i> StayFinder</h4>
    </div>
    <nav class="mt-3">
        <a href="{{ url_for('admin_dashboard') }}">
            <i class="bi bi-speedometer2 me-2"></i> Dashboard
        </a>
        <a href="{{ url_for('admin_properties') }}" class="active">
            <i class="bi bi-buildings me-2"></i> Properties
        </a>
        <a href="#">
            <i class="bi bi-people me-2"></i> Users
        </a>
        <a href="#">
            <i class="bi bi-gear me-2"></i> Settings
        </a>
        <a href="{{ url_for('admin_logout') }}">
            <i class="bi bi-box-arrow-right me-2"></i> Logout
        </a>
    </nav>
</div>

<!-- Main Content -->
<div class="main-content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-buildings me-2"></i>Properties</h2>
        <span class="badge bg-primary fs-6 py-2 px-3">
            Total: {{ properties|length }}
        </span>
    </div>

    {% if properties %}
    <div class="row g-4">
        {% for property in properties %}
        <div class="col-md-4 mb-4">
            <div class="card property-card h-100">
                <div class="card-img-container position-relative">
                    {% if property.images and property.images|length > 0 %}
                    <img src="{{ property.images[0] }}" alt="{{ property.name }}">
                    {% elif property.image %}
                    <img src="{{ property.image }}" alt="{{ property.name }}">
                    {% else %}
                    <div class="d-flex align-items-center justify-content-center h-100 bg-light">
                        <i class="bi bi-image text-muted" style="font-size: 3rem;"></i>
                    </div>
                    {% endif %}
                    
                    {% if property.type %}
                    <span class="badge bg-danger badge-type">{{ property.type }}</span>
                    {% endif %}
                    
                    {% if property.gender %}
                    <span class="badge bg-primary badge-gender">
                        {{ property.gender }}
                    </span>
                    {% endif %}
                    
                    {% if property.status %}
                        {% if property.status == 'approved' %}
                        <span class="badge bg-success badge-status">
                            <i class="bi bi-check-circle"></i> Approved
                        </span>
                        {% elif property.status == 'rejected' %}
                        <span class="badge bg-danger badge-status">
                            <i class="bi bi-x-circle"></i> Rejected
                        </span>
                        {% else %}
                        <span class="badge bg-warning badge-status">
                            <i class="bi bi-clock"></i> Pending
                        </span>
                        {% endif %}
                    {% endif %}
                </div>
                
                <div class="card-body">
                    <h5 class="card-title text-primary mb-2">{{ property.name or 'Unnamed Property' }}</h5>
                    
                    <p class="text-muted mb-2">
                        <i class="bi bi-geo-alt"></i> {{ property.location or property.address or 'N/A' }}
                    </p>
                    
                    <div class="mb-2 rating-block" data-hostel-id="{{ property.id }}">
                        {% if property.rating is defined %}
                        {% set rating_val = property.rating | float %}
                        <span class="static-rating">
                            {% for i in range(5) %}
                                {% if i < rating_val | int %}
                                <i class="bi bi-star-fill text-warning"></i>
                                {% elif i < rating_val %}
                                <i class="bi bi-star-half text-warning"></i>
                                {% else %}
                                <i class="bi bi-star text-warning"></i>
                                {% endif %}
                            {% endfor %}
                            <span class="text-muted ms-1 static-text">{{ rating_val }}/5 ({{ property.reviewCount or property.reviews or 0 }})</span>
                        </span>
                        {% else %}
                        <span class="static-rating text-muted">No ratings</span>
                        {% endif %}
                        <span class="live-rating ms-3">Loading...</span>
                    </div>
                    
                    {% if property.amenities %}
                    <div class="mb-3">
                        {% for amenity in property.amenities[:3] %}
                        <span class="amenity-badge">{{ amenity }}</span>
                        {% endfor %}
                        {% if property.amenities|length > 3 %}
                        <span class="amenity-badge">+{{ property.amenities|length - 3 }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <div class="price-section d-flex justify-content-between align-items-center pt-2 border-top">
                        <div>
                            {% if property.originalPrice %}
                            <span class="price-original">₹{{ property.originalPrice }}/-</span>
                            {% endif %}
                            <span class="price-discounted">₹{{ property.price or property.rent or 0 }}/-</span>
                            <small class="text-muted d-block">Monthly Rent</small>
                        </div>
                        <a href="{{ url_for('view_property', hostel_id=property.id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye"></i> View
                        </a>
                    </div>
                    
                    {% if property.status == 'approved' %}
                    <div class="alert alert-success mb-0 mt-2 py-2">
                        <i class="bi bi-check-circle"></i> This property is approved
                    </div>
                    {% elif property.status == 'rejected' %}
                    <div class="alert alert-danger mb-0 mt-2 py-2">
                        <i class="bi bi-x-circle"></i> This property is rejected
                    </div>
                    {% endif %}
                    
                    <div class="action-buttons d-flex gap-2 mt-3">
                        <form method="POST" action="{{ url_for('approve_property', hostel_id=property.id) }}" style="flex: 1;">
                            <button type="submit" class="btn btn-success btn-sm w-100">
                                <i class="bi bi-check-circle"></i> Approve
                            </button>
                        </form>
                        <form method="POST" action="{{ url_for('reject_property', hostel_id=property.id) }}" style="flex: 1;">
                            <button type="submit" class="btn btn-danger btn-sm w-100">
                                <i class="bi bi-x-circle"></i> Reject
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i> No properties found in the hostel collection.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.rating-block[data-hostel-id]').forEach(block => {
        const id = block.dataset.hostelId;
        if (!id) {
            block.querySelector('.live-rating').textContent = '';
            return;
        }
        fetch('/api/ratings/' + encodeURIComponent(id))
            .then(r => r.json())
            .then(data => {
                const avg = (data && data.avg) ? data.avg : 0;
                const count = (data && data.count) ? data.count : 0;
                let html = '';
                const full = Math.floor(avg);
                for (let i=0;i<5;i++){
                    if (i < full) html += '<i class="bi bi-star-fill text-warning"></i>';
                    else if (i < avg) html += '<i class="bi bi-star-half text-warning"></i>';
                    else html += '<i class="bi bi-star text-warning"></i>';
                }
                html += ' <span class="text-muted ms-1">' + avg + '/5 (' + count + ')</span>';
                const live = block.querySelector('.live-rating');
                if (live) live.innerHTML = html;
            })
            .catch(err => {
                const live = block.querySelector('.live-rating');
                if (live) live.textContent = 'Error';
            });
    });
});
</script>
{% endblock %}
